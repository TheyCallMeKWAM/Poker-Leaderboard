<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poker Night Leaderboard</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header>
        <h1>Poker Night Leaderboard</h1>
    </header>
    <main>
        <!-- Leaderboard Section -->
        <section id="leaderboard">
            <h2>Leaderboard</h2>
            <table>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Player</th>
                        <th>Total Won/Lost</th>
                        <th>Games Played</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    <!-- Dynamic content will go here -->
                </tbody>
            </table>
        </section>

        <!-- All Players Graph Section -->
        <section id="all-players-graph-section">
            <h2>Performance of All Players</h2>
            <canvas id="all-players-graph" width="800" height="400"></canvas>
        </section>
    </main>
    <script>
        const players = [];
        const games = [];

        // Function to add game data
        function addGame(date, results) {
            results.forEach(({ name, result }) => {
                games.push({ date, name, result });
                let player = players.find(p => p.name === name);
                if (!player) {
                    player = { name: name, total: 0, games: 0, breakdown: [] };
                    players.push(player);
                }
                player.total += result;
                player.games += 1;
                player.breakdown.push({ gamesPlayed: player.games, total: player.total });
            });
        }

        // Function to populate leaderboard
        function populateLeaderboard() {
        const leaderboardBody = document.getElementById("leaderboard-body");

        // Clear existing content
        leaderboardBody.innerHTML = "";

        // Sort players by total winnings (descending)
        const sortedPlayers = [...players].sort((a, b) => b.total - a.total);

        // Populate leaderboard rows
        sortedPlayers.forEach((player, index) => {
            const row = document.createElement("tr");
            row.classList.add("player-row"); // Optional for styling
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${player.name}</td>
                <td>${player.total >= 0 ? `$${player.total}` : `-$${Math.abs(player.total)}`}</td>
                <td>${player.games}</td>
            `;

            const dropdownRow = document.createElement("tr");
            dropdownRow.classList.add("dropdown-row");
            dropdownRow.style.display = "none";
            dropdownRow.innerHTML = `<td colspan="4" id="dropdown-${player.name}" class="dropdown-content"></td>`;

            // Add event listener for the entire row
            row.addEventListener("click", () => toggleDropdown(player.name));

            leaderboardBody.appendChild(row);
            leaderboardBody.appendChild(dropdownRow);
        });
    }

        function toggleDropdown(playerName) {
        const dropdownRow = document.querySelector(`#dropdown-${playerName}`).parentElement;
        if (dropdownRow.style.display === "none" || !dropdownRow.style.display) {
            const player = players.find(p => p.name === playerName);
            const dropdownContent = document.getElementById(`dropdown-${playerName}`);

            // Generate content with dates
            const uniqueDates = [...new Set(games.map(game => game.date))]; // Unique dates
            const gameDetails = uniqueDates.map(date => {
                const game = games.find(g => g.date === date && g.name === playerName);
                if (game) {
                    return `<p>${date}: ${game.result >= 0 ? `$${game.result}` : `-$${Math.abs(game.result)}`}</p>`;
                }
                return null; // Skip if the player didn't play on this date
            }).filter(entry => entry !== null).join("");

            dropdownContent.innerHTML = gameDetails;

            // Plot player graph
            plotPlayerGraph(playerName);

            dropdownRow.style.display = "table-row";
        } else {
            dropdownRow.style.display = "none";
        }
    }

    function plotPlayerGraph(playerName) {
    const dropdownContent = document.getElementById(`dropdown-${playerName}`);
    const canvasId = `graph-${playerName}`;

    // Create a canvas for the graph if it doesn't exist
    if (!document.getElementById(canvasId)) {
        const canvas = document.createElement('canvas');
        canvas.id = canvasId;
        dropdownContent.appendChild(canvas);
    }

    const player = players.find(p => p.name === playerName);
    const uniqueDates = [...new Set(games.map(game => game.date))];
    let cumulativeTotal = 0;

    const data = uniqueDates.map(date => {
        const game = games.find(g => g.date === date && g.name === playerName);
        if (game) {
            cumulativeTotal += game.result;
            return cumulativeTotal;
        }
        return null; // Use null for missing data
    });

    // Create the chart
    new Chart(document.getElementById(canvasId), {
        type: 'line',
        data: {
            labels: uniqueDates,
            datasets: [{
                label: `${playerName}`,
                data: data,
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            layout: {
                padding: {
                    top: 20,
                    right: 60,
                    bottom: 40, // Extra space for the x-axis labels
                    left: 20
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Dates'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Cumulative Total Won/Lost'
                    }
                }
            },
        }
    });
}

function plotAllPlayersGraph() {
    const uniqueDates = [...new Set(games.map(game => game.date))]; // Unique dates
    const datasets = players.map(player => {
    let cumulativeTotal = 0;

    const data = uniqueDates.map(date => {
        const game = games.find(g => g.date === date && g.name === player.name);
        if (game) {
            cumulativeTotal += game.result;
            return cumulativeTotal; // Use cumulative total
        }
        return null; // No point for this date
    });

    return {
        label: player.name,
        data: data,
        borderColor: getRandomColor(), // Use the updated function
        fill: false,
        tension: 0.4
    };
});

    // Custom plugin for drawing player names
    const labelPlugin = {
        id: 'lineLabels',
        afterDatasetsDraw(chart) {
            const { ctx, data } = chart;
            ctx.save();
            data.datasets.forEach((dataset, index) => {
                const meta = chart.getDatasetMeta(index);
                if (!meta.hidden) {
                    const lastPoint = meta.data[meta.data.length - 1];
                    if (lastPoint) {
                        ctx.font = '12px Arial';
                        ctx.fillStyle = dataset.borderColor;
                        ctx.textAlign = 'left';
                        ctx.fillText(dataset.label, lastPoint.x + 5, lastPoint.y - 5);
                    }
                }
            });
            ctx.restore();
        }
    };

    // Register the plugin
    Chart.register(labelPlugin);

    // Create the chart
    new Chart(document.getElementById('all-players-graph'), {
        type: 'line',
        data: {
            labels: uniqueDates,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            layout: {
                padding: {
                    top: 20,
                    right: 60, // Add space on the right for labels
                    bottom: 20,
                    left: 40 // Add space on the left for labels if needed
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Dates'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Cumulative Total Won/Lost'
                    }
                }
            },
            plugins: {
                lineLabels: true // Enable the custom label plugin
            }
        }
    });
}

        function getRandomColor() {
            // Generate RGB a in the mid-range (80â€“200)
            const r = Math.floor(Math.random() * (200 - 50) + 80);
            const g = Math.floor(Math.random() * (200 - 50) + 80);
            const b = Math.floor(Math.random() * (200 - 50) + 80);

            // Return the color in rgba format with 0.8 opacity
            return `rgba(${r}, ${g}, ${b})`;
        }

        // Example usage
        addGame("Jan 9th", [
            { name: "William", result: 50 },
            { name: "Michael", result: -81.30 },
            { name: "Warren", result: 0 },
            { name: "Kathy", result: 5 },
            { name: "Daniel", result: 0 },
            { name: "Aiden", result: 16.30 },
            { name: "Evan", result: 10 },
        ]);
        addGame("Jan 16th", [
            { name: "William", result: 10 },
            { name: "Michael", result: 5 },
            { name: "Warren", result: 0 },
            { name: "Kathy", result: -20 },
            { name: "Daniel", result: -29 },
            { name: "Aiden", result: 20 },
            { name: "Evan", result: 21 },
            { name: "Dany", result: -7 },
        ]);
        addGame("Jan 23rd", [
            { name: "William", result: 22.20 },
            { name: "Michael", result: 156 },
            { name: "Warren", result: 10 },
            { name: "Kathy", result: 51 },
            { name: "Daniel", result: -5 },
            { name: "Aiden", result: -25.20 },
            { name: "Evan", result: -160 },
            { name: "Dany", result: -36 },
        ]);


        populateLeaderboard();
        plotAllPlayersGraph();
    </script>
</body>
</html>